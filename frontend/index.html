<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyBuilding — Объекты</title>
    <link rel="icon" href="assets/design_key.png">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="budget.css">
    <link rel="stylesheet" href="expense.css">
    <link rel="stylesheet" href="analysis.css">
    <link rel="stylesheet" href="settings.css">
    <link rel="stylesheet" href="income_modal.css">
    <link rel="stylesheet" href="income_table_buttons.css">
</head>

<body>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img id="sidebar-logo" src="assets/design_key.png" alt="logo" style="display:none;" />
            <span>MYBUILDPRO</span>
            <button id="add-object">+</button>
        </div>
        <ul id="object-list" class="object-list"></ul>
    </div>
    <div class="main-content">
        <!-- ====== MS OFFICE STYLE RIBBON ====== -->
        
        <!-- Title Bar (Quick Access Toolbar) -->
        <div class="office-title-bar">
            <div class="title-bar-left">
                <button id="qat-save" class="qat-btn" title="Сохранить">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                </button>
                <button id="qat-undo" class="qat-btn" title="Отменить">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg>
                </button>
                <button id="qat-redo" class="qat-btn" title="Повторить">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 7v6h-6"/><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3L21 13"/></svg>
                </button>
                <button id="qat-print" class="qat-btn" title="Печать">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                </button>
            </div>
            <div class="title-bar-center">
                <div class="object-select-wrap">
                    <button id="object-select" class="object-select-btn title-bar-select">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                        <span id="selected-object-name">Выбор объекта</span>
                        <span class="caret">▾</span>
                    </button>
                    <div id="object-dropdown" class="object-dropdown" style="display:none;"></div>
                </div>
            </div>
            <div class="title-bar-right">
                <div class="search-box">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                    <input id="global-search" type="search" placeholder="Поиск..." />
                </div>
            </div>
        </div>

        <!-- Ribbon Tabs -->
        <div class="office-ribbon">
            <div class="ribbon-tabs">
                <button class="ribbon-tab active" data-ribbon="analysis">Аналитика</button>
                <button class="ribbon-tab" data-ribbon="budget">Смета</button>
                <button class="ribbon-tab" data-ribbon="finances">Финансы</button>
                <button class="ribbon-tab" data-ribbon="gpr">ГПР</button>
                <button class="ribbon-tab" data-ribbon="smr">СМР</button>
                <button class="ribbon-tab" data-ribbon="settings">Настройки</button>
            </div>
            
            <!-- Ribbon Panels -->
            <div class="ribbon-content">
                <!-- Analysis Ribbon Panel -->
                <div class="ribbon-panel active" data-panel="analysis">
                    <div class="ribbon-group">
                        <div class="ribbon-group-content row">
                            <button id="ribbon-object-data" class="ribbon-btn analysis-view active" data-view="object-data">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                                <span>Данные<br>объекта</span>
                            </button>
                        </div>
                        <span class="ribbon-group-label">Объект</span>
                    </div>
                    <div class="ribbon-separator"></div>
                    <div class="ribbon-group">
                        <div class="ribbon-group-content row">
                            <button id="ribbon-finance-analytics" class="ribbon-btn analysis-view" data-view="finance-analytics">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>
                                <span>Аналитика<br>по финансам</span>
                            </button>
                        </div>
                        <span class="ribbon-group-label">Финансы</span>
                    </div>
                    <div class="ribbon-separator"></div>
                    <div class="ribbon-group">
                        <div class="ribbon-group-content row">
                            <button id="ribbon-resource-analytics" class="ribbon-btn analysis-view" data-view="resource-analytics">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                                <span>Аналитика<br>по ресурсам</span>
                            </button>
                        </div>
                        <span class="ribbon-group-label">Ресурсы</span>
                    </div>
                    <div class="ribbon-separator"></div>
                    <div class="ribbon-group">
                        <div class="ribbon-group-content row">
                            <button id="ribbon-worktype-analytics" class="ribbon-btn analysis-view" data-view="worktype-analytics">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m14 13-8.381 8.38a1 1 0 0 1-3.001-3L11 9.999"/><path d="M15.973 4.027A13 13 0 0 0 5.902 2.373c-1.398.342-1.092 2.158.277 2.601a19.9 19.9 0 0 1 5.822 3.024"/><path d="M16.001 11.999a19.9 19.9 0 0 1 3.024 5.824c.444 1.369 2.26 1.676 2.603.278A13 13 0 0 0 20 8.069"/><path d="M18.352 3.352a1.205 1.205 0 0 0-1.704 0l-5.296 5.296a1.205 1.205 0 0 0 0 1.704l2.296 2.296a1.205 1.205 0 0 0 1.704 0l5.296-5.296a1.205 1.205 0 0 0 0-1.704z"/></svg>
                                <span>Аналитика<br>по видам работ</span>
                            </button>
                        </div>
                        <span class="ribbon-group-label">Работы</span>
                    </div>
                    <div class="ribbon-separator"></div>
                    <div class="ribbon-group">
                        <div class="ribbon-group-content row">
                            <button id="ribbon-stage-analytics" class="ribbon-btn analysis-view" data-view="stage-analytics">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M7 16h8"/><path d="M7 11h12"/><path d="M7 6h3"/></svg>
                                <span>Аналитика<br>по этапам</span>
                            </button>
                        </div>
                        <span class="ribbon-group-label">Этапы</span>
                    </div>
                </div>

                <!-- Budget Ribbon Panel -->
                <div class="ribbon-panel" data-panel="budget">
                    <!-- Budget List Controls (shown only in list view) -->
                    <div class="ribbon-group" id="budget-list-controls">
                        <div class="ribbon-group-content">
                            <button id="ribbon-add-budget" class="ribbon-btn large">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                                <span>Добавить<br>смету</span>
                            </button>
                        </div>
                        <span class="ribbon-group-label">Создание</span>
                    </div>
                    
                    <!-- Budget Detail Controls (shown only in detail view) -->
                    <div class="ribbon-group" id="budget-detail-controls" style="display:none;">
                        <div class="ribbon-group-content">
                            <button id="ribbon-add-stage" class="ribbon-btn large">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                                <span>Добавить<br>этап</span>
                            </button>
                        </div>
                        <span class="ribbon-group-label">Создание</span>
                    </div>
                    <div class="ribbon-separator" id="budget-detail-separator-1" style="display:none;"></div>
                    <div class="ribbon-group" id="budget-detail-toggle-group" style="display:none;">
                        <div class="ribbon-group-content row">
                            <button id="toggle-stages" class="ribbon-btn toggle-btn" data-state="expanded" title="Скрыть/раскрыть этапы">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M7 16h8"/><path d="M7 11h12"/><path d="M7 6h3"/></svg>
                                <span>Этапы</span>
                            </button>
                            <button id="toggle-worktypes" class="ribbon-btn toggle-btn" data-state="expanded" title="Скрыть/раскрыть виды работ">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m14 13-8.381 8.38a1 1 0 0 1-3.001-3L11 9.999"/><path d="M15.973 4.027A13 13 0 0 0 5.902 2.373c-1.398.342-1.092 2.158.277 2.601a19.9 19.9 0 0 1 5.822 3.024"/><path d="M16.001 11.999a19.9 19.9 0 0 1 3.024 5.824c.444 1.369 2.26 1.676 2.603.278A13 13 0 0 0 20 8.069"/><path d="M18.352 3.352a1.205 1.205 0 0 0-1.704 0l-5.296 5.296a1.205 1.205 0 0 0 0 1.704l2.296 2.296a1.205 1.205 0 0 0 1.704 0l5.296-5.296a1.205 1.205 0 0 0 0-1.704z"/></svg>
                                <span>Виды работ</span>
                            </button>
                        </div>
                        <span class="ribbon-group-label">Скрыть/Раскрыть</span>
                    </div>
                    <div class="ribbon-separator" id="budget-detail-separator-2" style="display:none;"></div>
                    <div class="ribbon-group" id="budget-detail-photo-group" style="display:none;">
                        <div class="ribbon-group-content row">
                            <button id="toggle-photos" class="ribbon-btn toggle-btn" data-state="visible" title="Скрыть/показать фото">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                                <span>Фото</span>
                            </button>
                        </div>
                        <span class="ribbon-group-label">Отображение</span>
                    </div>
                    <div class="ribbon-separator" id="budget-detail-separator-3" style="display:none;"></div>
                    <div class="ribbon-group" id="budget-detail-filter-group" style="display:none;">
                        <div class="ribbon-group-content">
                            <div class="ribbon-dropdown-wrap">
                                <select id="resource-type-filter" class="ribbon-select">
                                    <option value="">-- Все ресурсы --</option>
                                    <option value="Трудоресурсы">Трудоресурсы</option>
                                    <option value="Материал">Материал</option>
                                    <option value="Доставка">Доставка</option>
                                    <option value="Оборудование">Оборудование</option>
                                    <option value="Техника">Техника</option>
                                    <option value="Мебель">Мебель</option>
                                    <option value="Инструменты">Инструменты</option>
                                    <option value="Коммуналка">Коммуналка</option>
                                    <option value="Документация">Документация</option>
                                    <option value="Расходные материалы">Расходные материалы</option>
                                    <option value="Питание">Питание</option>
                                </select>
                            </div>
                        </div>
                        <span class="ribbon-group-label">Фильтр</span>
                    </div>
                </div>

                <!-- Finances Ribbon Panel -->
                <div class="ribbon-panel" data-panel="finances">
                    <div class="ribbon-group">
                        <div class="ribbon-group-content row">
                            <button class="ribbon-btn finances-subtab large active" data-subtab="income">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14"/><path d="m19 12-7 7-7-7"/></svg>
                                <span>Приход</span>
                            </button>
                            <button class="ribbon-btn finances-subtab large" data-subtab="expense">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19V5"/><path d="m5 12 7-7 7 7"/></svg>
                                <span>Расход</span>
                            </button>
                        </div>
                        <span class="ribbon-group-label">Раздел</span>
                    </div>
                    <div class="ribbon-separator"></div>
                    <div class="ribbon-group" id="finance-creation-group">
                        <div class="ribbon-group-content">
                            <button id="ribbon-add-finance" class="ribbon-btn large">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                                <span>Добавить</span>
                            </button>
                        </div>
                        <span class="ribbon-group-label">Создание</span>
                    </div>
                </div>

                <!-- GPR Ribbon Panel (empty for now) -->
                <div class="ribbon-panel" data-panel="gpr">
                    <div class="ribbon-group">
                        <div class="ribbon-group-content">
                            <span class="ribbon-placeholder">ГПР — в разработке</span>
                        </div>
                    </div>
                </div>

                <!-- SMR Ribbon Panel (empty for now) -->
                <div class="ribbon-panel" data-panel="smr">
                    <div class="ribbon-group">
                        <div class="ribbon-group-content">
                            <span class="ribbon-placeholder">СМР — в разработке</span>
                        </div>
                    </div>
                </div>

                <!-- Settings Ribbon Panel (empty for now) -->
                <div class="ribbon-panel" data-panel="settings">
                    <div class="ribbon-group">
                        <div class="ribbon-group-content row">
                            <button id="ribbon-add-block" class="ribbon-btn" onclick="BlocksModule.editBlock()">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="7" height="7"/>
                                    <rect x="14" y="3" width="7" height="7"/>
                                    <rect x="14" y="14" width="7" height="7"/>
                                    <rect x="3" y="14" width="7" height="7"/>
                                </svg>
                                <span>Добавить<br>блок</span>
                            </button>
                            <button id="ribbon-refresh-blocks" class="ribbon-btn" onclick="BlocksModule.loadBlocks()">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="23 4 23 10 17 10"/>
                                    <polyline points="1 20 1 14 7 14"/>
                                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                                </svg>
                                <span>Обновить</span>
                            </button>
                        </div>
                        <span class="ribbon-group-label">Блоки</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Area (keep existing tab-content) -->
        <div id="tab-analysis" class="tab-content" style="display:none;">
            <div class="tab-actions">
                <button class="icon-btn" id="download-analysis" title="Скачать">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="#0057d8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-file-down-icon lucide-file-down">
                        <path
                            d="M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z" />
                        <path d="M14 2v5a1 1 0 0 0 1 1h5" />
                        <path d="M12 18v-6" />
                        <path d="m9 15 3 3 3-3" />
                    </svg>
                </button>
            </div>
            <div id="analysis-container"></div>
        </div>
        <div id="tab-income" class="tab-content" style="display:none;">
            <div class="tab-actions">
                <button class="icon-btn" id="add-income" title="Добавить">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <circle cx="10" cy="10" r="9" stroke="#0057d8" stroke-width="2" />
                        <path d="M10 6v8M6 10h8" stroke="#0057d8" stroke-width="2" stroke-linecap="round" />
                    </svg>
                </button>
                <button class="icon-btn" id="download-income" title="Скачать">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="#0057d8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-file-down-icon lucide-file-down">
                        <path
                            d="M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z" />
                        <path d="M14 2v5a1 1 0 0 0 1 1h5" />
                        <path d="M12 18v-6" />
                        <path d="m9 15 3 3 3-3" />
                    </svg>
                </button>
            </div>
            <!-- Фильтры прихода -->
            <div class="income-filters">
                <div class="filter-group">
                    <label>Дата с:</label>
                    <input type="date" id="filter-date-from" class="filter-input">
                </div>
                <div class="filter-group">
                    <label>по:</label>
                    <input type="date" id="filter-date-to" class="filter-input">
                </div>
                <div class="filter-group">
                    <label>Тип операции:</label>
                    <select id="filter-operation-type" class="filter-select">
                        <option value="">Все</option>
                        <option value="income">Приход</option>
                        <option value="transfer">Перевод</option>
                        <option value="return">Возврат</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Сумма от:</label>
                    <input type="number" id="filter-amount-from" class="filter-input" placeholder="мин">
                </div>
                <div class="filter-group">
                    <label>до:</label>
                    <input type="number" id="filter-amount-to" class="filter-input" placeholder="макс">
                </div>
                <div class="filter-group">
                    <label>Валюта:</label>
                    <select id="filter-currency" class="filter-select">
                        <option value="">Все</option>
                        <option value="UZS">UZS</option>
                        <option value="USD">USD</option>
                        <option value="RUB">RUB</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Кто передал:</label>
                    <input type="text" id="filter-sender" class="filter-input" placeholder="Поиск...">
                </div>
                <div class="filter-group">
                    <label>Кто получил:</label>
                    <input type="text" id="filter-receiver" class="filter-input" placeholder="Поиск...">
                </div>
                <button type="button" id="clear-filters" class="filter-clear-btn" title="Сбросить фильтры">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
            </div>
            <div class="income-table-wrap">
                <table class="income-table">
                    <thead>
                        <tr>
                            <th>№</th>
                            <th>Дата</th>
                            <th>Фото</th>
                            <th>Тип операции</th>
                            <th>Из объекта</th>
                            <th>Сумма</th>
                            <th>Валюта</th>
                            <th>Блок</th>
                            <th>Кто передал</th>
                            <th>Кто получил</th>
                            <th>Комментарии</th>
                            <th style="width:80px;"></th>
                        </tr>
                    </thead>
                    <tbody id="income-tbody">
                        <!-- Строки будут добавляться динамически -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="5" style="text-align:right;font-weight:600;">Итого:</td>
                            <td id="income-total" style="font-weight:600;">0</td>
                            <td colspan="2">&nbsp;</td>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                            <td colspan="4">&nbsp;</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Модальное окно для добавления прихода -->
        <!-- Enhanced Income Modal - Replace lines 105-122 in index.html -->
        <div id="income-modal" class="modal" style="display:none;">
            <div class="modal-content income-modal-enhanced">
                <span class="modal-close" id="income-modal-close">&times;</span>
                <h3>Добавить приход</h3>
                <form id="income-form" class="income-form-grid">
                    <!-- Row 1: Date and Operation Type -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>Дата</label>
                            <input type="date" id="income-date" required>
                        </div>
                        <div class="form-group">
                            <label>Тип операции</label>
                            <select id="income-operation-type" required>
                                <option value="income">Приход</option>
                                <option value="debt">Долг из другого объекта</option>
                                <option value="return">Возврат</option>
                            </select>
                        </div>
                    </div>

                    <!-- Row 1.5: Source Object (only for debt type) -->
                    <div class="form-row" id="source-object-row" style="display:none;">
                        <div class="form-group full-width">
                            <label>Объект-источник</label>
                            <select id="income-source-object">
                                <option value="">Выберите объект</option>
                                <!-- Objects will be populated dynamically -->
                            </select>
                        </div>
                    </div>

                    <!-- Row 2: Photo Preview -->
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>Фото</label>
                            <div class="photo-upload-area">
                                <input type="file" id="income-photo" accept="image/*" style="display:none;">
                                <div class="photo-preview-box" id="income-photo-preview">
                                    <button type="button" class="photo-upload-btn" id="income-photo-upload-btn">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                                            <circle cx="8.5" cy="8.5" r="1.5" />
                                            <polyline points="21 15 16 10 5 21" />
                                        </svg>
                                        <span>Выбрать фото</span>
                                    </button>
                                    <div class="photo-preview-container" style="display:none;">
                                        <img id="income-photo-img" src="" alt="Preview">
                                        <button type="button" class="photo-delete-btn" id="income-photo-delete-btn">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2">
                                                <line x1="18" y1="6" x2="6" y2="18" />
                                                <line x1="6" y1="6" x2="18" y2="18" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Row 3: Amount and Currency -->
                    <div class="form-row">
                        <div class="form-group flex-2">
                            <label>Сумма</label>
                            <input type="text" id="income-amount" required placeholder="0">
                        </div>
                        <div class="form-group flex-1">
                            <label>Валюта</label>
                            <select id="income-currency" required>
                                <option value="UZS" selected>UZS</option>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="RUB">RUB</option>
                                <option value="CNY">CNY</option>
                            </select>
                        </div>
                    </div>

                    <!-- Row 4: From and To -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>Кто передал</label>
                            <input type="text" id="income-from" required>
                        </div>
                        <div class="form-group">
                            <label>Кто получил</label>
                            <input type="text" id="income-to" required>
                        </div>
                    </div>

                    <!-- Row 4.5: Budget Block -->
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>Блок (из утвержденной сметы)</label>
                            <select id="income-budget-block">
                                <option value="">Выберите блок</option>
                                <!-- Blocks from approved budgets will be populated dynamically -->
                            </select>
                        </div>
                    </div>

                    <!-- Row 5: Comments -->
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>Комментарии</label>
                            <textarea id="income-comment" rows="3"></textarea>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="btn-submit">Сохранить</button>
                </form>
                <input type="hidden" id="income-edit-index">
            </div>
        </div>

        <!-- Budget Modal -->
        <div id="budget-modal" class="modal" style="display:none;">
            <div class="modal-content income-modal-enhanced">
                <span class="modal-close" id="budget-modal-close">&times;</span>
                <h3 id="budget-modal-title">Добавить смету</h3>
                <form id="budget-form" class="income-form-grid">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Дата начала разработки</label>
                            <input type="date" id="budget-date-start" required>
                        </div>
                        <div class="form-group">
                            <label>№ Договора</label>
                            <input type="text" id="budget-contract-number" required placeholder="ДГП-123">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Название сметы</label>
                            <input type="text" id="budget-name" required placeholder="ЖК Березка Корпус 1">
                        </div>
                        <div class="form-group">
                            <label>Раздел сметы *</label>
                            <select id="budget-section" required>
                                <option value="">Выберите раздел</option>
                                <option value="АР">АР - Архитектура</option>
                                <option value="КР">КР - Конструкция</option>
                                <option value="ЭО">ЭО - Электрика</option>
                                <option value="ОВ">ОВ - Отопление и Вентиляция</option>
                                <option value="ВК">ВК - Водоснабжение и канализация</option>
                                <option value="БЛ">БЛ - Благоустройство</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Блок</label>
                            <input type="text" id="budget-block" placeholder="Блок А" readonly>
                            <small style="color: #666; font-size: 12px;">Автоматически заполняется из выбранного блока</small>
                        </div>
                        <div class="form-group">
                            <label>Версия</label>
                            <input type="text" id="budget-version" required placeholder="v1" value="v1">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Статус</label>
                            <select id="budget-status" required>
                                <option value="draft">Черновик</option>
                                <option value="active">Новый</option>
                                <option value="approved">Утвержден</option>
                                <option value="inactive">Не активный</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>Комментарии</label>
                            <textarea id="budget-comment" rows="3"></textarea>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn-submit">Сохранить</button>
                </form>
                <input type="hidden" id="budget-edit-id">
            </div>
        </div>

        <div id="tab-budget" class="tab-content" style="display:none;">
            <div class="tab-actions">
                <button class="icon-btn" id="add-budget-group" title="Добавить этап">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="#0057d8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-folder-down-icon lucide-folder-down">
                        <path
                            d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z" />
                        <path d="M12 10v6" />
                        <path d="m15 13-3 3-3-3" />
                    </svg>
                </button>
                <button class="icon-btn" id="download-budget" title="Скачать">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="#0057d8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-file-down-icon lucide-file-down">
                        <path
                            d="M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z" />
                        <path d="M14 2v5a1 1 0 0 0 1 1h5" />
                        <path d="M12 18v-6" />
                        <path d="m9 15 3 3 3-3" />
                    </svg>
                </button>
            </div>
            
            <!-- Budget List View (default) -->
            <div id="budget-list-view">
                <div class="budget-list-table-wrapper">
                    <table class="budget-list-table">
                        <thead>
                            <tr class="filter-row">
                                <th>
                                    <label>Дата начала:</label>
                                    <input type="date" id="filter-budget-date-start" class="filter-input">
                                </th>
                                <th>
                                    <label>Название:</label>
                                    <input type="text" id="filter-budget-name" class="filter-input" placeholder="Поиск...">
                                </th>
                                <th>
                                    <label>Блок:</label>
                                    <input type="text" id="filter-budget-block" class="filter-input" placeholder="Поиск...">
                                </th>
                                <th>
                                    <label>№ Договора:</label>
                                    <input type="text" id="filter-budget-contract" class="filter-input" placeholder="Поиск...">
                                </th>
                                <th>
                                    <label>Версия:</label>
                                    <input type="text" id="filter-budget-version" class="filter-input" placeholder="v1...">
                                </th>
                                <th>
                                    <label>Статус:</label>
                                    <select id="filter-budget-status" class="filter-input">
                                        <option value="">Все</option>
                                        <option value="draft">Черновик</option>
                                        <option value="active">Новый</option>
                                        <option value="approved">Утвержден</option>
                                        <option value="inactive">Не активный</option>
                                    </select>
                                </th>
                                <th>
                                    <label>Дата изм.:</label>
                                    <input type="date" id="filter-budget-date-modified" class="filter-input">
                                </th>
                                <th>
                                    <label>Сумма:</label>
                                    <input type="text" id="filter-budget-amount" class="filter-input" placeholder="0">
                                </th>
                                <th></th>
                                <th>
                                    <button id="clear-budget-filters" class="clear-filters-btn" title="Очистить фильтры">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                                    </button>
                                </th>
                            </tr>
                            <tr class="header-row">
                                <th>№</th>
                                <th>Дата начала</th>
                                <th>Название сметы</th>
                                <th>Блок</th>
                                <th>№ Договора</th>
                                <th>Версия</th>
                                <th>Статус</th>
                                <th>Дата редактирования</th>
                                <th>Сумма</th>
                                <th>Комментарии</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="budget-list-tbody">
                            <!-- Budget rows will be rendered here -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="8" style="text-align:right;font-weight:600;">Итого:</td>
                                <td id="budget-total" style="font-weight:600;">0</td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            
            <!-- Budget Detail View (hidden by default) -->
            <div id="budget-detail-view" style="display:none;">
                <div class="budget-detail-navbar">
                    <button id="back-to-budget-list" class="budget-navbar-btn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="19" y1="12" x2="5" y2="12"/>
                            <polyline points="12 19 5 12 12 5"/>
                        </svg>
                        <span>Назад к списку смет</span>
                    </button>
                    <div class="budget-detail-info">
                        <h2 id="budget-detail-title">Название сметы</h2>
                        <span id="budget-detail-status" class="budget-status-badge">Черновик</span>
                    </div>
                </div>
                
                <div id="budget-container"></div>
            </div>
        </div>

        <div id="tab-expense" class="tab-content" style="display:none;">
            <div class="tab-actions">
                <button class="icon-btn" id="download-expense" title="Скачать">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="#0057d8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-file-down-icon lucide-file-down">
                        <path
                            d="M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z" />
                        <path d="M14 2v5a1 1 0 0 0 1 1h5" />
                        <path d="M12 18v-6" />
                        <path d="m9 15 3 3 3-3" />
                    </svg>
                </button>
            </div>
            <div id="expense-container"></div>
        </div>
        
        <!-- Settings Tab -->
        <div id="tab-settings" class="tab-content" style="display:none;">
            <div class="settings-container">
                <h2 style="margin: 20px 0; color: #1a1a1a; font-weight: 600;">Управление блоками объекта</h2>
                
                <div class="tab-actions" style="margin-bottom: 20px;">
                    <button class="icon-btn" id="add-block" title="Добавить блок">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <circle cx="10" cy="10" r="9" stroke="#0057d8" stroke-width="2" />
                            <path d="M10 6v8M6 10h8" stroke="#0057d8" stroke-width="2" stroke-linecap="round" />
                        </svg>
                    </button>
                </div>
                
                <div id="blocks-table-container">
                    <table class="data-table" id="blocks-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">№</th>
                                <th style="width: 300px;">Название блока</th>
                                <th style="width: 150px;">Статус</th>
                                <th style="width: 100px;">Цвет</th>
                                <th style="width: 100px;">Порядок</th>
                                <th style="width: 150px;">Действия</th>
                            </tr>
                        </thead>
                        <tbody id="blocks-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <button id="sidebar-close" class="sidebar-close" style="display:none;">✕</button>

    <!-- Block Modal -->
    <div id="block-modal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 500px;">
            <span class="modal-close" id="block-modal-close">&times;</span>
            <h2 id="block-modal-title">Добавить блок</h2>
            <form id="block-form">
                <input type="hidden" id="block-id">
                
                <label for="block-name">Название блока *</label>
                <input type="text" id="block-name" required placeholder="Например: Корпус А">
                
                <label for="block-status">Статус *</label>
                <select id="block-status" required>
                    <option value="active">Активный</option>
                    <option value="paused">Приостановлен</option>
                    <option value="inactive">Неактивный</option>
                </select>
                
                <label for="block-color">Цвет *</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="color" id="block-color" value="#3B82F6" style="width: 60px; height: 40px; cursor: pointer; border: 1px solid #ddd; border-radius: 4px;">
                    <span id="block-color-hex" style="font-family: monospace; color: #666;">#3B82F6</span>
                </div>
                
                <label for="block-order">Порядок сортировки</label>
                <input type="number" id="block-order" value="0" min="0" step="1">
                
                <div class="modal-actions">
                    <button type="submit" class="btn-primary">Сохранить</button>
                    <button type="button" class="btn-secondary" id="block-cancel">Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Модалка для просмотра фото -->
    <div id="photo-modal" class="modal" style="display:none;">
        <div class="modal-content"
            style="max-width:90vw;max-height:90vh;display:flex;flex-direction:column;align-items:center;">
            <span class="modal-close" id="photo-modal-close">&times;</span>
            <img id="photo-modal-img" src=""
                style="max-width:80vw;max-height:70vh;border-radius:10px;box-shadow:0 2px 16px #0002;" alt="Фото">
        </div>
    </div>

    <script src="app.js"></script>
    <script src="budget.js"></script>
    <script src="expense.js"></script>
    <script src="analysis.js"></script>
    <script src="blocks.js"></script>
</body>

</html>